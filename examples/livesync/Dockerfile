FROM node:18 as base

WORKDIR /app
RUN curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm
COPY . .
RUN pnpm install

FROM base as dev

ENV ADBC_ABLY_API_KEY=${ADBC_ABLY_API_KEY}
ENV NEXT_PUBLIC_ADBC_ABLY_API_KEY=${NEXT_PUBLIC_ADBC_ABLY_API_KEY}
ENV ADBC_POSTGRES_CONNECTION_URI=${ADBC_POSTGRES_CONNECTION_URI}
ENV ADBC_OUTBOX_TABLE_AUTO_CREATE=${ADBC_OUTBOX_TABLE_AUTO_CREATE}
ENV ADBC_NODES_TABLE_AUTO_CREATE=${ADBC_NODES_TABLE_AUTO_CREATE}

RUN pnpm build
EXPOSE 3002

CMD pnpm start -- -p 3002
